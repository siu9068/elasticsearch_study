## 3.1 매핑 API 이해하기
매핑은 색인 시 데이터가 어디에 어떻게 저장될지를 결정하는 설정이다.  
인덱스에 추가되는 각 데이터 타입을 구체적으로 정의하는 일이다.
엘라스틱서치는 기본적으로 스키마리스이기 때문에 명시적으로 필드를 정의하지 않아도 데이터 유형에 따라 필드 데이터 타입에 대한 매핑 정보가 자동으로 생성된다.  
하지만 잘못 생성된 매핑의 타입은 변경할수 없기 때문에 탑입을 변경하려면 인덱스를 삭제한 후 다시 생성하거나 매핑을 다시 정의해야한다.  
매핑 정보를 설정할 때는 다음과 같은 사항을 고민해야 한다.
~~~
- 문자열을 분석할 것인가?
- _source에 어떤 필드를 정의할 것인가?
- 날짜필드를 가지는 필드는 무엇인가?
- 매핑에 정의되지 않고 유입되는 필드는 어떻게 처리할 것인가?
~~~
실무에서는 다양한 이유로 동적 매핑을 거의 사용하지 않는다.  
따라서 인덱스를 생성할 때 항상 명시적인 매핑 설정을 사용한다.

### 3.1.1 매핑 인덱스 만들기
인덱스명은 movie_search  

|   매핑명    |         필드명         |       필드 타입       |
|:--------:|:-------------------:|:-----------------:|
|   인덱스키   |       moiveCd       |      keyword      |
| 영화제목_국문  |       movieNm       |       text        |
| 영화제목_영문  |      movieNmEn      |       text        |
|   제작연도   |      prdtYear       |      integer      |
|   개봉연도   |       openDt        |      integer      |
|   영화유형   |       typeNm        |      keyword      |
|   제작상태   |     prdtStatNm      |      keyword      |
| 제작국가(전체) |      nationAlt      |      keyword      |
|  장르(전체)  |      genreAlt       |      keyword      |
| 대표 제작국가  |     repNationNm     |      keyword      |
|   재표장르   |     repGenreNm      |      keyword      |
|  영화감독명   | directors.peopleNm  | object -> keyword |
|  제작사코드   | companies.companyCd | object -> keyword |
|   제작사명   | companies.companyNm | object -> keyword |
~~~
PUT movie_search
{
  "settings": {
    "number_of_shards": 5,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "moiveCd":{
        "type": "keyword"
      },
      "movieNm":{
        "type": "text"
      },
      "moiveNmEn":{
        "type": "text"
      },
      "prdtYear":{
        "type": "integer"
      },
      "openDt":{
        "type": "integer"
      },
      "typeNm":{
        "type": "keyword"
      },
      "prdtStatNm":{
        "type": "keyword"
      },
      "nationAlt":{
        "type": "keyword"
      },
      "genreAlt":{
        "type": "keyword"
      },
      "repNationNm":{
        "type": "keyword"
      },
      "repGenreNm":{
        "type": "keyword"
      },
      "directors": {
        "properties": {
          "peopleNm": {
            "type": "keyword"
          }
        }
      },
      "companies": {
        "properties": {
          "companyCd": {
            "type": "keyword"
          },
          "companyNm": {
            "type": "keyword"
          }
        }
      }
    }
  }
}
~~~

### 3.1.2 매핑 확인
이미 만들어진 매핑을 확인하려면 엘라스틱서치에서 제공하는 _mapping API를 사용할 수 있다. 앞에서 만든 movie_search 인덱스의 매핑정보를 확인한다.
> GET movie_search/_mapping

### 3.1.3 매핑 파라미터
- analyzer  
해당 필드의 데이터를 형태소 분석하겠다는 의미의 파라미터다. 색인과 검색 시 지정한 분석기로 형태소 분석을 수행한다.  
text 타입의 필드는 analyzer 매핑 파라미터를 기본적으로 사용해야 하며, 별도 지정을 안할 시 Standard Analzer로 형태소 분석을 수행한다.
- normalizer  
term query에 분석기를 사용하기 위해 사용된다.  
예를들어 keyword 데이터 타입의 경우 원문을 기준으로 문서가 색인되기 때문에 cafe,Cafe,Café는 서로 다른 문서로 인식된다.  
하지만 해당 유형을 normalizer를 통해 분석기에 asciifolding과 같은 필터를 사용하면 같은 데이터로 인식되게 할 수 있다.
- coerce  
색인 시 자동 변환을 허용할지 여부를 설정하는 파라미터다.  
예를 들어 "10" 과같은 integer타입이 필드에 들어온다면 엘리스틱서치가 자동으로 형변환을 수행해서 정상적으로 처리한다.  
하지만 coerce 설정을 미상용으로 변경한다면 색인에 실패한다.
- copy_to  
매핑 파라미터를 추가한 필드의 값을 지정한 필드로 복사한다. 또한 여러개의 필드 데이터를 하나의 필드에 모아서 전체검색 용도로 사용한다.
~~~
{
  "moiveCd": "20173732",
  "movieNm":"살아남은 아이",
  "movieNmEn":"Last Child",
}
~~~
위와 같이 색인된 문서에서 copy_to 파라미터를 이용하면 movieNm과 movieNmEn의 결과를 합해서 "살아남은 아이 Last Child" 라는 데이터를 저장하는 필드를 생성 할 수 있다. 
- fielddata  
엘라스틱서치가 힙 공간에 생성하는 메모리 캐시다. 최신버전 엘라스틱캐시는 doc_values라는 새로운 형태의 캐시를 사용한다.  
부득이하게 text 타입의 필드에서 집계나 정렬을 수행하는 경우 fielddata를 사용할 수 있다. 하지만 메모리에 생성되는 캐시이기 때문에 최소한으로만 사용 해야 한다.  
fielddata는 메모리 소모가 크기 때문에 기본적으로 비활성화 돼 있다. 사용법은 다음과 같다.
~~~
PUT movie_search_mapping/_mapping/_doc
{
  "properties": {
    "nationAlt":{
        "type": "text",
        "fielddata": true
      }
  }
}
~~~
- doc_values  
엘라스틱서치에서 사용하는 기본캐시다.  
text 타입을 제외한 모든 타입에서 기본적으로 doc_values 캐시를 사용한다. 과거에는 캐시를 모두 메모리에 올려 사용했으나 현재는 힙 사용에 대한 부담을 없애고,  
운영체제의 파일 시스템 캐시를 통해 디스크에 있는 데이터에 빠르게 접근할 수 있다. 이로인해 GC의 비용이 거의 들지 않으며 메모리 연산과 비슷한 성능을 보여준다.  
필드를 정렬,집계할 필요가 없고 스크립트에서 필드 값에 엑세스할 필요가 없다면 디스크 공간 절약을 위해 doc_values를 비활성화할 수도 있다.  
한번 비활성화된 필드는 인덱스를 재색인하지 않는 한 변경이 불가능하다.
- dynamic  
매핑에 필드를 추가하 때 동적으로 생성할지를 결정한다. 동적 생성 필드의 처리 방법은 세 가지 설정중 하나를 지정할 수 있다.
~~~
1. true - 새로 추가되는 필드를 매핑에 추가한다.
2. false - 새로 추가되는 필드를 무시한다. 해당 필드는 색인되지 않아 검색할 수 없지만 _source에는 표시된다.
3. strict - 새로운 필드가 감지되면 예외가 발생하고 문서 자체가 색인되지 않는다. 새로 유입되는 필드는 사용자가 매핑에 명시적으로 추가해야 한다.
~~~
- enabled  
검색 결과에는 포함하지만 색인은 하고 싶지 않은 경우도 있다. 메타 성격의 데이터가 그렇다. 예를들어 일반적인 게시판이라면 제목과 요약글만 색인하고 날짜와 사용자 ID는 색인하지 않는 경우다.  
색인을 원하지 않는 날짜와 사용자 ID의 매핑 파라미터 중 enabled를 false로 설정하면 _source에는 검색되지만 색인은 하지 않는다.
- format  
엘라스틱서치는 날짜/시간을 문자열로 표시한다. 이떄 날짜/시간을 문자열로 변경할 때 미리 구성한 포맷을 사용할 수 있다.  

|                                    포맷                                     |            날짜 형식            |          비고           |
|:-------------------------------------------------------------------------:|:---------------------------:|:---------------------:|
|                                basic_date                                 |          yyyyMMdd           |        년도/월/일         |
|                              basic_date_time                              |    yyyMMdd'T'HHmmss.SSSZ    | 년도/월/일/T/시/분/초/밀리초/Z  |
|                                basic_time                                 |         HHmmss.SSS          |      시/분/초/밀리초/Z      |
|                             date/strict_date                              |         yyyy-MM-dd          |        년도/월/일         |
|        date_hour_minute_second/<br/>strict_date_hour_minute_second        |   yyyy-MM-dd'T'HH:mm:ss.    |    년도/월/일/T/시/분/초     |
| date_hour_minute_second_millis/<br/>strict_date_hour_minute_second_millis | yyyy-MM-dd'T'HH:mm:ss.SSS.  |  년도/월/일/T/시/분/초/밀리초   |
|                        date_time/strict_date_time                         | yyyy-MM-dd'T'HH:mm:ss.SSSZZ | 년도/월/일/T/시/분/초/밀리초/ZZ |

- ignore_above  
필드에 저장되는 문자열이 지정한 크기를 넘어서면 빈 값으로 색인한다. 지정한 값이 아니라 빈 값으로 저장되므로 주의한다.
- ignore_malformed  
엘라스틱서치에서는 잘못된 데이터 타입을 색인하려고 하면 예외가 발생하고 해당 문서 전체가 색인되지 않는다.  
이 매핑파라미터를 사용하면 해당필드만 무시하고 문서는 색인할 수 있다.
- index  
필드값을 색인할지를 결정한다. 기본값은 true이며, false로 변경하면 해당 필드를 색인하지 않는다.
- fields  
다중 필드(multifield)를 설정할 수 있는 옵션이다. 필드 안에 또 다른 필드의 정보를 추가할 수 있어 같은 string값을 각각 다른분석기로 처리하도록 설정할 수 있다.  
다음과 같이 기본 필드는 전문 검색을 하고 필드 안의 추가 필드는 집계용으로 사용할 수 있다.
~~~
PUT movie_search_mapping
{
  "mappings": {
    "properties": {
      "awards":{
        "type": "text",
        "fields": {
          "name": {
            "type" : "keyword"
          }
        }
      }
    }
  }
}
~~~
- norms  
문서의 _score 값 계산에 필요한 정규화 인수를 사용할지 여부를 설정한다. 기본값은 true.  
_score 계산이 필요없거나 단순 필터링 용도로 사용하는 필드는 비활성화해서 디스크 공간을 절약할 수 있다.
- null_value  
엘라스틱서치는 색인 시 문서에 필드가 없거나 필드의 값이 null이면 색인 시 필드를 생성하지 않는다.  
이 경우 null_value를 설정하면 문서의 값이 null이더라도 필드를 생성하고 그에 해당하는 값으로 저장한다.
~~~
PUT movie_search_mapping/_mapping
{
  "properties": {
    "audiCnt": {
      "type": "integer",
      "null_value": "0"
    }
  }
}
~~~
- position_increment_gap  
배열(Array) 형태의 데이터를 색인할 때 검색의 정확도를 높이기 위해 제공하는 옵션이다.  
필드 데이터 중 단어와 단어 사이의 간격(slop)을 허용할지를 설정한다. 검색 시 단어와 단어 사이의 간격을 기준으로 일치하는 문서를 찾는 데 필요하다.  
예를 들어, 데이터가 ["Jhon Abraham", "Lincon Smith"]일 때 "Abraham Lincon"으로 검색하더라도 검색이 가능하다.
- properties  
오브젝트(Object) 타입이나 중첩(Nested) 타입의 스키마를 정의할 때 사용되는 옵션으로 필드의 타입을 매핑한다.  
오브젝트 필드 및 중첩필드에는 properties라는 서브 필드가 있다. 이 properties는 object나 nested를 포함한 모든 데이터 타입이 될 수 있다.
- search_analyzer  
일반적으로는 색인과 검색 시 같은 분석기를 사용한다. 만약 다른 분석기를 사용하고 싶은 경우 search_analyzer를 설정해서 검색 시 사용할 분석기를 별도로 지정할 수 있다.  
- similarity  
유사도 측정 알고리즘을 지정한다. 유사도 측정 방식을 기본 알고리즘인 BM25에서 다른 알고리즘으로 변경할 수 있다.

|  알고리즘   |                                                             설명                                                             | 
|:-------:|:--------------------------------------------------------------------------------------------------------------------------:|
|  BM25   |                                        Okapi BM25 알고리즘이다. 엘라스틱서치의 기본 유사도 측정 알고리즘이다.                                        |
| classic |                                   TF/IDF 알고리즘이다. 문서 내 용어의 개수와 전체 용어의 개수를 이용해 유사도를 계산한다.                                    |
| boolean | 복잡한 수학적 모델을 사용하지 않고 단순히 boolean 연산으로 유사도를 측정한다. score는 검색어 일치 여부에 따라결정되며,<br/>검색 결과의 일치여부에 따라 쿼리의 가중치에 사용된 점수로만 유사도를 계산한다. |

- store  
필드의 값을 저장해 검색 결과에 값을 포함하기 위한 매핑 파라미터다.  
기본적으로 _source에 색인된 문서가 저장된다. 하지만 store 매핑 파라미터를 사용하면 해당 필드를 자체적으로 저장할 수 있다.  
예를 들어 10개의 필드가 존재하고 해당 필드에 데이터를 매핑한 상태라면 _source를 로드해서 해당 필드를 찾는 것보다 사용할 각 필드만 로드해서 사용하는 편이 효율적이다.  
하지만 해당 매핑 파라미터를 사용하면 디스크를 더 많이 사용한다.
- term_vector  
루씬에서 분석된 용어의 정보를 포함할지 여부를 결정하는 매핑 파라미터다. 설정 가능한 인자는 다음과 같다.

|           인자            |                 설명                 | 
|:-----------------------:|:----------------------------------:|
|           no            |           텀벡터를 저장하지 않는다.           |
|           yes           |           필드와 용어만 저장한다.            |
|     with_positions      |      용어, 용어의 시작과 끝 위치를 저정한다.       |
|      with_offsets       |         용어, 문자 오프셋을 저정한다.          |
| with_positions_offsets  | 용어, 용어의 시작과 끝 위치, 문자 오프셋을 모두 저장한다. |
